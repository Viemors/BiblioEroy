<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meu Perfil</title>
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="../img/favicon-32.png"
    />
    <link rel="stylesheet" href="../css/perfis.css" />
    <link rel="stylesheet" href="../css/perfis-responsividade.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
    ></script>
    <script defer src="../js/perfis.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@100..900&display=swap");

      .only {
        font-weight: bold;
        color: brown;
      }
    </style>
  </head>

  <script>
    function editar() {
      const input = document.querySelectorAll("input:not(.only)");
      input.forEach((input) => {
        input.removeAttribute("readonly");
        input.placeholder = "digite o novo valor";
      });
    }

    function abrir() {
      const modal = document.querySelector(".modal-fundo");
      modal.style.opacity = 1;
      modal.style.pointerEvents = "all";
    }

    function fechar() {
      const modal = document.querySelector(".modal-fundo");
      modal.style.opacity = 0;
      modal.style.pointerEvents = "none";
    }

    function abrirConfirmacao() {
      const modal = document.querySelector(".modal-fundo-confirmacao");
      modal.style.opacity = 1;
      modal.style.pointerEvents = "all";
    }

    function fecharConfirmacao() {
      const modal = document.querySelector(".modal-fundo-confirmacao");
      modal.style.opacity = 0;
      modal.style.pointerEvents = "none";
    }
  </script>

  <body>
    <%- include("../partials/header") %> <%- include('../partials/navbar') %>

    <div class="container-fluid">
      <div class="row justify-content-center">
        <div class="col-12 offset-0 col-md-10 offset-md-1 col-lg-8">
          <div class="modal-fundo-confirmacao">
            <div class="modal-cont">
              <h1>
                Olá <%=result.username%>! Tem certeza que pretende continuar?
              </h1>
              <p>
                Apagar a sua conta é uma ação irreversível, todos os seus dados
                serão apagados.
              </p>
              <button type="button" class="btn btn-outline-primary">
                <a
                  href="/deleteCadastro"
                  style="text-decoration: none; color: inherit"
                  >Apagar Conta</a
                >
              </button>
              <button
                type="button"
                class="btn btn-outline-primary"
                onclick="fecharConfirmacao()"
              >
                Cancelar
              </button>
            </div>
          </div>

          <div class="modal-fundo">
            <div class="modal-cont">
              <h1>Olá <%=result.username%>!</h1>
              <% if (Object.keys(atrasos).length > 0) { %>
              <p>
                Opa! Parece que você possui empréstimos atrasados, por favor
                verifique.
              </p>
              <ul>
                <% for (let i = 0; i < Object.keys(atrasos).length; i++) { %>
                <li>
                  Livro: <%= atrasos[i].Idlivro %> - Data de devolução: <%=
                  atrasos[i].datafinal %>
                </li>
                <% } %>
              </ul>
              <% } else { %>
              <p>Não há empréstimos atrasados no momento, parabéns!</p>
              <% } %>
              <span class="fechar" onclick="fechar()">&times;</span>
            </div>
          </div>

          <!-- FLASH MESSAGES -->
          <% if (error && error.length) { %>
          <div class="flash flash-error text-center text-danger">
            <% error.forEach(function(msg) { %>
            <p><%= msg %></p>
            <% }) %>
          </div>
          <% } %> <% if (success && success.length) { %>
          <div class="flash flash-success text-center text-success">
            <% success.forEach(function(msg) { %>
            <p><%= msg %></p>
            <% }) %>
          </div>
          <% } %>

          <form action="/atualizarCadastro?_method=PUT" method="POST">
            <div class="profile-layout">
              <div class="foto-container text-center mb-4">
                <h1>Meu Perfil</h1>
                <img src="../img/leitor.jpeg" class="foto mb-3" />
                <h2>Olá <%=result.nome%>!</h2>
              </div>

              <div class="fields-container">
                <div class="row mb-3">
                  <div class="col-12">
                    <label>Conta</label>
                    <input
                      type="text"
                      class="only"
                      readonly
                      value="<%=result.tipo_conta%>"
                      name="tipo_conta"
                    />
                  </div>
                </div>

                <div class="row mb-3">
                  <div class="col-12">
                    <label>Nome</label>
                    <input
                      type="text"
                      class="only"
                      readonly
                      value="<%=result.nome%>"
                      name="nome"
                    />
                  </div>
                </div>

                <div class="row mb-3">
                  <div class="col-12">
                    <label>Usuário</label>
                    <input
                      type="text"
                      readonly
                      placeholder="<%=result.username%>"
                      name="username"
                    />
                  </div>
                </div>

                <div class="row mb-3">
                  <div class="col-12">
                    <label>Email</label>
                    <input
                      type="email"
                      readonly
                      placeholder="<%=result.email%>"
                      name="email"
                    />
                  </div>
                </div>

                <div class="row mb-3">
                  <div class="col-12">
                    <label>Senha</label>
                    <input type="password" readonly name="senha" />
                  </div>
                </div>

                <div class="row justify-content-center mb-3">
                  <div
                    class="col-12 d-flex justify-content-center gap-2 flex-wrap"
                  >
                    <button
                      type="submit"
                      class="btn btn-outline-primary"
                      id="button"
                    >
                      Salvar
                    </button>
                    <button
                      type="button"
                      onclick="editar()"
                      class="btn btn-outline-primary"
                      id="button"
                    >
                      Editar
                    </button>
                    <button
                      type="button"
                      class="btn btn-outline-primary"
                      id="button-sair"
                    >
                      <a
                        href="/perfil/leitor"
                        style="text-decoration: none; color: inherit"
                        >Cancelar</a
                      >
                    </button>
                  </div>
                </div>

                <div class="row justify-content-center mb-3">
                  <div
                    class="col-12 d-flex justify-content-center gap-2 flex-wrap"
                  >
                    <button
                      type="button"
                      class="btn btn-outline-primary"
                      id="button-sair"
                    >
                      <a
                        href="/sair"
                        style="text-decoration: none; color: inherit"
                        >Sair da conta</a
                      >
                    </button>
                    <button
                      type="button"
                      class="btn btn-outline-primary"
                      onclick="abrirConfirmacao()"
                      id="button-sair"
                    >
                      Excluir conta
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </form>

          <h2>Meus livros</h2>

          <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mt-4">
            <% for(let i = 0; i < Object.keys(livros).length; i++) { %>
            <div class="col">
              <div class="card h-100">
                <img
                  src="<%=todosLivros[i].imagem%>"
                  class="img-fluid"
                  height="225"
                  alt="<%=todosLivros[i].titulo%>"
                />

                <form
                  action="/devolucao"
                  method="POST"
                  class="card-body d-flex flex-column"
                >
                  <input
                    type="hidden"
                    name="titulo"
                    value="<%=todosLivros[i].titulo%>"
                  />

                  <h5 class="card-title">
                    <a
                      href="/perfilLivro/<%=todosLivros[i].id%>"
                      style="text-decoration: none; color: inherit"
                      ><%=todosLivros[i].titulo%></a
                    >
                  </h5>

                  <p class="card-text"><%=todosLivros[i].descricao%></p>

                  <button
                    type="button"
                    class="btn btn-sm btn-link read-more"
                    style="padding: 0; text-align: left"
                  >
                    Ler mais
                  </button>

                  <input
                    type="hidden"
                    name="autor"
                    value="<%=todosLivros[i].autor%>"
                  />
                  <input
                    type="hidden"
                    name="categoria"
                    value="<%=todosLivros[i].categoria%>"
                  />
                  <input
                    type="hidden"
                    name="idleitor"
                    value=""
                    class="idleitor"
                    required
                  />

                  <div class="mt-auto d-flex justify-content-between">
                    <button type="submit" class="btn btn-outline-danger">
                      <i
                        class="bi bi-arrow-return-left"
                        style="padding-right: 5px"
                      ></i
                      >Devolver
                    </button>
                  </div>
                </form>
              </div>
            </div>
            <% } %>
          </div>

          <script>
            document.addEventListener("DOMContentLoaded", function () {
              const buttons = document.querySelectorAll(".read-more");

              buttons.forEach((button) => {
                button.addEventListener("click", function () {
                  // Encontra o parágrafo .card-text que está ANTES do botão clicado
                  const cardText = this.previousElementSibling;

                  cardText.classList.toggle("expanded");

                  if (cardText.classList.contains("expanded")) {
                    this.textContent = "Ler menos";
                  } else {
                    this.textContent = "Ler mais";
                  }
                });
              });
            });
          </script>
        </div>
      </div>
    </div>

    <%- include('../partials/footer') %>
  </body>
</html>
